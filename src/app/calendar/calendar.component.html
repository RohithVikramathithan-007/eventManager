<div class="calendar-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Event Calendar</mat-card-title>
      <mat-card-subtitle>{{ getWeekRange() }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Week Navigation -->
      <div class="week-navigation">
        <button mat-icon-button (click)="previousWeek()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="week-range">{{ getWeekRange() }}</span>
        <button mat-icon-button (click)="nextWeek()">
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button mat-button (click)="goToCurrentWeek()">Today</button>
      </div>

      <!-- Category Filter -->
      <div class="filter-section">
        <mat-form-field appearance="outline">
          <mat-label>Filter by Category</mat-label>
          <mat-select [(ngModel)]="selectedCategory" (selectionChange)="onCategoryFilterChange()">
            <mat-option [value]="null">All Categories</mat-option>
            <mat-option *ngFor="let cat of categories" [value]="cat">{{ cat }}</mat-option>
          </mat-select>
        </mat-form-field>
        <button *ngIf="selectedCategory" mat-button (click)="clearFilter()">Clear Filter</button>
      </div>

      <!-- Calendar Grid -->
      <div class="calendar-grid">
        <div *ngFor="let day of weekDays" class="day-column">
          <div class="day-header">
            <div class="day-name">{{ getDayName(day.date) }}</div>
            <div class="day-date">{{ day.date.getDate() }}</div>
          </div>
          <div class="timeslots-container">
            <div *ngFor="let timeslot of day.timeslots" class="timeslot-card" 
                 [class.ended]="isEventEnded(timeslot)"
                 [class.full]="isFull(timeslot) && !isEventEnded(timeslot) && !isCancelled(timeslot)"
                 [class.booked-by-user]="isBookedByUser(timeslot)"
                 [class.cancelled]="isCancelled(timeslot)"
                 [class.rescheduled]="isRescheduled(timeslot)">
              <div class="timeslot-header">
                <div class="event-name">{{ timeslot.name }}</div>
                <span class="category-chip">{{ timeslot.category }}</span>
                <span *ngIf="isCancelled(timeslot)" class="status-badge cancelled-badge">
                  <mat-icon>cancel</mat-icon>
                  Cancelled
                </span>
                <span *ngIf="isRescheduled(timeslot)" class="status-badge rescheduled-badge">
                  <mat-icon>event_repeat</mat-icon>
                  Rescheduled
                </span>
              </div>
              
              <!-- Event Description with Status -->
              <div class="event-description" *ngIf="isCancelled(timeslot) || isRescheduled(timeslot)">
                <div *ngIf="isCancelled(timeslot)" class="status-message cancelled-message">
                  <mat-icon>info</mat-icon>
                  <span>This event has been cancelled by the administrator.</span>
                </div>
                <div *ngIf="isRescheduled(timeslot)" class="status-message rescheduled-message">
                  <mat-icon>info</mat-icon>
                  <span>This event has been rescheduled to a new date and time.</span>
                  <span *ngIf="timeslot.original_date" class="original-details">
                    Original: {{ formatDisplayDate(timeslot.original_date) }} at {{ formatTime(timeslot.original_start_time || '') }} - {{ formatTime(timeslot.original_end_time || '') }}
                  </span>
                </div>
              </div>
              
              <div class="timeslot-time">
                {{ formatTime(timeslot.start_time) }} - {{ formatTime(timeslot.end_time) }}
                <span *ngIf="isRescheduled(timeslot) && timeslot.original_date" class="original-time">
                  (Originally: {{ formatTime(timeslot.original_start_time || '') }} - {{ formatTime(timeslot.original_end_time || '') }})
                </span>
              </div>
              <div class="seats-info">
                <span *ngIf="!isEventEnded(timeslot) && !isCancelled(timeslot)" class="seats-available">
                  <mat-icon>event_seat</mat-icon>
                  {{ getAvailableSeats(timeslot) }} / {{ timeslot.capacity }} seats available
                </span>
                <span *ngIf="isCancelled(timeslot)" class="cancelled-label">
                  <mat-icon>cancel</mat-icon>
                  Event Cancelled
                </span>
                <span *ngIf="isEventEnded(timeslot) && !isCancelled(timeslot)" class="ended-label">
                  <mat-icon>event_busy</mat-icon>
                  Event Ended
                </span>
                <span *ngIf="isFull(timeslot) && !isEventEnded(timeslot) && !isCancelled(timeslot)" class="full-label">
                  <mat-icon>event_busy</mat-icon>
                  Full
                </span>
              </div>
              <div class="booked-users" *ngIf="authService.isAdmin() && timeslot.booked_by.length > 0">
                <strong>Booked by:</strong>
                <span *ngFor="let userId of timeslot.booked_by" class="booked-user">{{ userId }}</span>
              </div>
              <div class="timeslot-actions">
                <button *ngIf="canBook(timeslot)" 
                        mat-raised-button 
                        color="primary" 
                        (click)="bookTimeslot(timeslot)">
                  Book
                </button>
                <button *ngIf="isBookedByUser(timeslot) && !isCancelled(timeslot)" 
                        mat-raised-button 
                        color="warn" 
                        (click)="unbookTimeslot(timeslot)">
                  Unbook
                </button>
                <span *ngIf="isFull(timeslot) && !isBookedByUser(timeslot) && !isEventEnded(timeslot) && !isCancelled(timeslot)" class="booked-label">
                  Full
                </span>
                <span *ngIf="isEventEnded(timeslot) && !isCancelled(timeslot)" class="booked-label">
                  Ended
                </span>
                <span *ngIf="isCancelled(timeslot)" class="booked-label">
                  Cancelled
                </span>
              </div>
            </div>
            <div *ngIf="day.timeslots.length === 0" class="no-timeslots">
              No timeslots available
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>